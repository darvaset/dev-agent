# Task: Implement Enhanced History - Save Full Prompt & Gemini Response

## Context

The DevAgent project aims to improve its history tracking as part of Phase 1.1 of the roadmap. Currently, only a summary of task execution is saved in `~/.devagent/projects/{project_hash}/history.json`. This task focuses on implementing the first two steps of the enhanced history: saving the full original prompt and the complete Gemini API response for each execution.

This change will provide a richer historical record, crucial for future features like feedback systems and auto-learning.

## Requirements

1.  **Modify `src/devagent/context.py`:**
    *   **Create a new method `_get_task_history_dir(task_id: str) -> Path`**: This method should create and return a unique directory for each task within the project's history. For example, `~/.devagent/projects/{project_hash}/history/{task_id}/`. The `task_id` can be a unique identifier generated by `DevAgent` (e.g., a combination of timestamp and a hash).
    *   **Update `add_history_entry(prompt_name: str, result: dict)`**:
        *   This method should now accept additional arguments for the full prompt content and the full Gemini response content.
        *   Generate a `task_id` for the current execution (e.g., using `datetime.now().strftime("%Y%m%d%H%M%S")` and a short hash of the prompt name).
        *   Use `_get_task_history_dir` to get the path for this specific task's history.
        *   Save the full prompt content to a file (e.g., `prompt.md`) within this task's history directory.
        *   Save the full Gemini response content to a file (e.g., `response.json`) within this task's history directory.
        *   The `history.json` entry should be updated to store the *relative paths* to these saved prompt and response files, instead of trying to store their full content directly.
        *   Ensure `history.json` remains a lean summary, linking to the full content files.

2.  **Modify `src/devagent/agent.py`:**
    *   **In the `execute` method**:
        *   After `enriched_prompt` is built and `response` is received from `_call_gemini`, pass `enriched_prompt` and `response.text` to the `project_ctx.add_history_entry` method.
        *   The `result` dictionary (which is passed to `add_history_entry`) should be updated to include the contents of the full prompt and Gemini response, or references to them, to facilitate storage. The `add_history_entry` method will then be responsible for saving these to files and storing their paths in `history.json`.

## Files to Modify

- `src/devagent/agent.py`
- `src/devagent/context.py`

## Validation

After running DevAgent with this prompt, we will validate the implementation by:

1.  **Running a test task:** Execute `devagent run prompts/implement-enhanced-history.md`. (Note: This is just a dummy prompt to trigger DevAgent's execution; its content is not important for *this* validation).
2.  **Inspecting `history.json`**: Check the file `~/.devagent/projects/{project_hash}/history.json`. A new entry should appear for the executed task, and it should contain `task_id`, `full_prompt_path`, and `full_gemini_response_path` fields.
3.  **Verifying saved files**: Navigate to the task-specific history directory (e.g., `~/.devagent/projects/{project_hash}/history/{task_id}/`). Confirm that `prompt.md` and `response.json` files exist and contain the expected full content.

## Important Notes

- Ensure proper error handling for file operations.
- The `task_id` should be unique enough for each execution.
- The `history.json` file should only store *metadata* and *references* (paths) to the full content, not the full content itself.
